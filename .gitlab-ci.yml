stages:
  - build
  - test

variables:
  IMAGE_NAME: monorepo-nginx
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - cd devtools/nginx
    - docker build -t $CI_REGISTRY_IMAGE/$IMAGE_NAME:$IMAGE_TAG -t $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest .
    - docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME:$IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest
  only:
    - main
    - develop
    - merge_requests

test:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Running Docker container..."
    - cd devtools/nginx
    - docker build -t $IMAGE_NAME:test .
    - docker run -d -p 8080:80 --name test-container $IMAGE_NAME:test
    - sleep 3
    - echo "Testing application..."
    - |
      response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
      if [ "$response" -eq 200 ]; then
        echo "✅ Test passed! Server responded with HTTP 200"
      else
        echo "❌ Test failed! Server responded with HTTP $response"
        exit 1
      fi
    - echo "Checking page content..."
    - |
      if curl -s http://localhost:8080 | grep -q "Welcome to the World"; then
        echo "✅ Content check passed! Page contains expected content"
      else
        echo "❌ Content check failed! Page does not contain expected content"
        exit 1
      fi
    - docker logs test-container
  after_script:
    - docker stop test-container || true
    - docker rm test-container || true
  only:
    - main
    - develop
    - merge_requests